# Docker

[01-今日课程介绍3_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1LQ4y127n4?p=42&vd_source=796ed40051b301bfa3a84ba357f4828c)的自学笔记

# 一. Docker是什么

> 什么是Docker：
> - 帮助我们快速构建应用镜像、交付应用、运行应用的技术
>
> 什么是镜像：
>
> - 将应用程序及其依赖、环境、配置打包在一起就是镜像
>
> 什么是容器:
>
> - 镜像运行起来就是容器，一个镜像可以运行多个容器
>
> Docker工作流：
>
> - 构建自定义镜像或者从Docker Registry拉取镜像
> - 根据镜像创建容器，并运行

## 1. Docker解决的问题

1. **项目部署的问题**
   大型项目组件较多，运行环境也较为复杂，部署时会碰到一些**问题**：
   - 依赖关系复杂，容易出现兼容性问题
   - 开发、测试、生产环境有差异
2. **Docker解决依赖的兼容**
   - 将应用的Libs（函数库）、Deps（依赖）、配置与应用一起打包
   - 将每个应用放到一个隔离**容器**去运行，避免互相干扰
3. **Docker解决不同系统环境**
   - Docker将用户程序与所需要调用的系统(比如Ubuntu)函数库一起打包
   - Docker运行到不同操作系统时，直接基于打包的库函数，借助于操作系统的Linux内核来运行
4. **Docker解决大型项目依赖关系复杂，不同组件依赖的兼容性**
   - Docker允许开发中将应用、依赖、函数库、配置一起**打包**，形成可移植镜像
   - Docker应用运行在容器中，使用沙箱机制，相互**隔离**
5. **Docker解决开发、测试、生产环境有差异**
   - Docker镜像中包含完整运行环境，包括系统函数库，仅依赖系统的Linux内核，因此可以在任意Linux操作系统上运行

## 2. Docker是什么技术

**Docker是一个快速交付应用、运行应用的技术**

- 可以将程序及其依赖、运行环境一起**打包为一个镜像**，可以迁移到任意Linux操作系统
- 运行时利用**沙箱机制**形成隔离容器，各个应用互不干扰
- 启动、移除都可以通过一行命令完成，方便快捷

## 3.Docker与虚拟机的区别

**虚拟机**（virtual machine）是在操作系统中**模拟硬件设备**，然后运行另一个操作系统，比如在 Windows 系统里面运行 Ubuntu 系统，这样就可以运行任意的Ubuntu应用了。

| 特性     | Dockers            | 虚拟机                       |
| -------- | ------------------ | ---------------------------- |
| 性能     | 接近原生           | 性能较差                     |
| 硬盘占用 | 一般为 MB          | 一般为GB                     |
| 启动     | 秒级               | 分钟级                       |
| 本质     | 是一个系统进程     | 是在操作系统中的操作系统     |
| 量级     | 体积小、启动速度快 | 体积大、启动速度慢、性能一般 |

## 4. 镜像(Image)和容器(Container)

**镜像(Image)：将应用程序及其依赖、环境、配置打包在一起**,Docker将应用程序及其所需的依赖、函数库、环境、配置等文件<u>打包</u>在一起，称为镜像。

**容器(Container)：镜像运行起来就是容器，一个镜像可以运行多个容器**,镜像中的应用程序运行后形成的进程就是容器，只是Docker会给容器做<u>隔离</u>，对外不可见。

## 5. Docker和Docker Hub

[Docker Hub](https://hub.docker.com/): 是一个Docker镜像的托管平台。这样的平台称为Docker Registry。

l国内也有类似于Docker Hub 的公开服务，比如 [网易云镜像服务](https://c.163yun.com/hub)、[阿里云镜像库](https://cr.console.aliyun.com/)等。

## 6. Docker的CS架构

Docker是一个CS架构的程序，由两部分组成：

1. **u服务端(server)：接收命令或远程请求，操作镜像或容器**,Docker守护进程，负责处理Docker指令，管理镜像、容器等
2. **u客户端(client)：发送命令或者请求到Docker服务端**,通过命令或Rest API向Docker服务端发送指令。可以在本地或远程向服务端发送指令。

## 7. Centos7安装Docker

请参考[Centos7安装Docker.md](Centos7安装Docker.md)

# 二.Docker基本操作

## 1.镜像操作

### 1.1 镜像相关命令

| 命令   | 语法                                      | 用途                |
| ------ | ----------------------------------------- | ------------------- |
| help   | docker [命令名] --help                    | 查看帮助文档        |
| pull   | docker pull 镜像名称                      | 从镜像仓库拉取镜像  |
| push   |                                           | 推送镜像到镜像仓库  |
| images | docker images                             | 查看拉取到的镜像    |
| save   | docker save -o 保存到的位置 镜像名称:版本 | 将镜像导出为tar文件 |
| rmi    | docker rmi 镜像名称:版本                  | 删除镜像            |
| load   | docker load  -i 磁盘文件                  | 加载tar文件为镜像   |



镜像名称一般分两部分组成：``[repository]:[tag]``。

在没有指定tag时，默认是latest，代表最新版本的镜像

<img src="../../MDImg/微服务/Docker/1.1.1docker镜像操作命令.png">

### 1.2案例

 #### 1.2.1案例一 从Docker Hub中拉取一个Nginx镜像并查看

> 1. 首先去镜像仓库搜索Nginx镜像，比如[Docker Hub](https://hub.docker.com/):
> 2. 根据查看到的镜像名称，拉取自己需要的镜像，通过命令：`docker pull nginx`
> 3. 通过命令：`docker images` 查看拉取到的镜像

#### 1.2.2案例二 利用docker save将nginx镜像导出磁盘，然后再通过load加载回来

>1. 利用`docker xx --help`命令查看`docker save`和`docker load`的语法
>2. 使用`docker save -o 保存到的位置 镜像名称:版本`导出镜像到磁盘 
>3. 使用`docker rmi 镜像名称:版本`删除镜像
>4. 使用`docker load 导出至磁盘的文件名`加载镜像

## 2.容器操作

### 2.1 容器相关命令

| 命令                                                         | 语法                                                         | 含义                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [exec](####2.2.2 进入Nginx容器，修改HTML文件内容，添加“传智教育欢迎您”) | docker exec -it 容器名称 bash                                | 进入容器执行命令，可以进入容器修改文件，但是在容器内修改文件是不推荐的 |
| logs                                                         | docker logs [-f] 容器名         (-f：持续查看日志)           | 查看容器运行日志                                             |
| ps                                                           | docker [-a] ps (-a: 所有的)                                  | 查看所有的容器及状态(默认运行中的)                           |
| [run](####2.2.1 创建运行一个Nginx容器)                       | docker run --name 自定义容器名 -p 主机端口:容器端口 [-d] 镜像名称 | 创建并运行一个容器                                           |
| start                                                        | docker start 容器名称                                        | 启动容器(停止->运行)                                         |
| stop                                                         | docker stop 容器名称                                         | 停止容器(运行->停止)                                         |
| pause                                                        | docker pause 容器名称                                        | 暂停容器(运行->暂停)                                         |
| unpause                                                      | docker unpause 容器名称                                      | 继续容器(暂停->运行)                                         |
| rm                                                           | docker rm [-f] 容器名称 (-f 强制删除，包括运行中的)          | 删除的容器                                                   |

<img src="../../MDImg/微服务/Docker/2.1.1docke容器操作命令.png">

### 2.2容器案例

#### 2.2.1 创建运行一个Nginx容器

> 去[docker hub](https://hub.docker.com/)查看Nginx的容器运行命令
>
> `docker run --name containerName -p 80:80 -d nginx`
>
> 命令解读:
>
> | 命令段               | 含义                                                         |
> | -------------------- | ------------------------------------------------------------ |
> | docker run           | 创建并运行一个容器                                           |
> | --name 自定义容器名  | 给容器起一个名字                                             |
> | -p 宿主端口:容器端口 | 指定端口映射，冒号左侧是宿主机端口，右侧是容器端口(容器是隔离的，做映射后，客户想要访问容器，客户机的请求给服务器的端口此端口映射容器端口，相当于给隔离容器打开了一个窗(端口)) |
> | -d                   | 后台运行容器                                                 |
> | nginx                | 镜像名称，例如nginx                                          |

#### 2.2.2 进入Nginx容器，修改HTML文件内容，添加“传智教育欢迎您”

>1. 进入容器。进入我们刚刚创建的nginx容器的命令为
>     `docker exec -it mn bash `
>     命令解读
>
>   | 命令段      | 含义                                                         |
>   | ----------- | ------------------------------------------------------------ |
>   | docker exec | 进入容器内部，执行一个命令                                   |
>   | -it         | 给当前进入的容器创建一个标准输入、输出终端，允许我们与容器交互 |
>   | mn          | 要进入的容器的名称                                           |
>   | bash        | 进入容器后执行的命令，bash是一个linux终端交互命令            |
>
>2. 进入nginx的HTML所在目录 /usr/share/nginx/html
>
>   `cd /usr/share/nginx/html`
>
>3. 修改index.html的内容
>
>   `sed -i 's#Welcome to nginx#传智教育欢迎您#g' index.html`
>
>   `sed -i 's#<head>#<head><meta charset="utf-8">#g' index.html`

#### 2.2.3 redis容器练习

1. 创建并运行一个redis容器，并且支持数据持久化

   > 1. 到DockerHub搜索Redis镜像
   >
   > 2. 查看Redis镜像文档中的帮助信息
   >
   > 3. 利用docker run 命令运行一个Redis容器
   >
   >    `docker run --name mr redis -p 6379:6379 -d redis redis-server --appendonly yes`

2. 进入redis容器，并执行redis-cli客户端命令，存入num=666

   >1. 进入redis容器
   >
   >   `docker exec -it redis bash`
   >
   >2. 执行redis-cli客户端命令
   >
   >   `redis-cli`
   >
   >3. 设置数据num=666
   >
   >   `set num 666`

## 3.数据卷(容器数据管理)

#### 3.1解决什么问题？

**解决容器与数据耦合的问题**：

> 1. **不便于修改**
>    - 当我们要修改Nginx的html内容时，需要进入容器内部修改，很不方便。
> 2. **数据不可复用**
>    - 在容器内的修改对外是不可见的。所有修改对新创建的容器是不可复用的
> 3. **升级维护困难**
>    - 数据在容器内，如果要升级容器必然删除旧容器，所有数据都跟着删除了

#### 3.2 数据卷是什么 ？原理？作用？

**数据卷（volume）是一个虚拟目录**，指向宿主机文件系统中的某个目录

**原理：**

<img src="../../MDImg/微服务/Docker/2.1.2docker数据卷.png">

**作用：**将容器与数据分离，解耦合，方便操作容器内数据，保证数据安全

#### 3.3 操作数据卷(volume)命令

| 命令   | 语法                                          | 含义                                   |
| ------ | --------------------------------------------- | -------------------------------------- |
| volume | docker volume [[命令](#####volume后跟随命令)] | 根据命令后跟随的命令来确定下一步的操作 |

##### volume后跟随命令

| 命令    | 语法                             | 含义                                         |
| ------- | -------------------------------- | -------------------------------------------- |
| create  | docker volume creat 数据卷名称   | 创建一个volume                               |
| inspect | docker volume inspect 数据卷名称 | 显示一个或多个volume的信息(包含挂载点信息等) |
| ls      | docker volume ls                 | 列出所有的volume                             |
| prune   | docker volume prune              | 删除未使用的volume                           |
| rm      | docker volume rm 数据卷名称      | 删除一个或多个指定的volume                   |

#### 3.4 数据卷案例

##### 3.4.1 创建一个数据卷，并查看数据卷在宿主机的目录位置

>1. 创建数据卷名为html
>     `docker volume create html`
>2. 查看所有数据
>     `docker volume ls`
>3. 查看数据卷详细信息卷
>     `docker volume inspect html`
